# Docker Compose

```yml
version: '3.8'

services:
  # ENTORNO DE DESARROLLO
  # Contenedor para Postgres DEV
  db_dev:
    image: postgres:14
    container_name: db_dev
    environment:
      - POSTGRES_DB=postgres
      - POSTGRES_USER=odoo
      - POSTGRES_PASSWORD=paso
    ports:
      - '5432:5432'
    volumes:
      - c:\Users\alejandro.redfer.2\Documents\OdooDesarrollo\dataPG:/var/lib/postgresql/data
  #  Contenedor para Odoo DEV
  odoo_dev:
    image: odoo:16
    container_name: odoo_dev
    environment:
      - HOST=db_dev
      - USER=odoo
      - PASSWORD=paso
    ports:
      - '8069:8069'
    volumes:
      - c:\Users\alejandro.redfer.2\Documents\OdooDesarrollo\volumesOdoo\addons:/mnt/extra-addons
      - c:\Users\alejandro.redfer.2\Documents\OdooDesarrollo\volumesOdoo/filestore:/var/lib/odoo/filestore
    depends_on:
      - db_dev
    command: --dev=all

  # ENTORNO DE PRODUCCIÓN
  # Contenedor para Postgres PROD 
  db_prod:
    image: postgres:14
    container_name: db_prod
    environment:
      - POSTGRES_DB=postgres
      - POSTGRES_USER=odoo
      - POSTGRES_PASSWORD=paso
    ports:
      - '5433:5432'
    volumes:
      - c:\Users\alejandro.redfer.2\Documents\OdooProduccion\dataPG:/var/lib/postgresql/data
  #  Contenedor para Odoo PROD
  odoo_prod:
    image: odoo:16
    container_name: odoo_prod
    environment:
      - HOST=db_prod
      - USER=odoo
      - PASSWORD=paso
    ports:
      - '8070:8069'
    volumes:
      - c:\Users\alejandro.redfer.2\Documents\OdooProduccion\volumesOdoo\addons:/mnt/extra-addons
    depends_on:
      - db_prod
```
## Documentación general

- ```version```: define la versión del formato de Docker Compose.
- ```services```: define la lista de contenedores que componenen la aplicación completa
- ```image```: Docker busca esta imagen localmente, sino la encuentra, la descarga de DockerHub.
- ```container_name```: le da un nombre al contenedor. Si no se pone, Docker le asigna uno aleatorio.
- ```environment```: lista de variables que se inyectan dentro del contenedor. Pueden ser usuario, contraseñas...
- ```ports```: mapea un puerto de la máquina local y un puerto dentro del contenedor.
- ```volumes```: define una carpeta compartida en la máquina anfitrión y el propio contenedor.
- ```depends_on```: controla el orden de arranque. Es decir, un contenedor no arranca hasta que otro esté iniciado. 
  
## Documentación concreta

- Dev
  - db_dev
    - Usa la base de datos postgres
    - Crea un usuario "Odoo" con la contraseña "paso" para la base de datos
    - Guarda los datos en OdooDesarrollo/dataPG
  - odoo_dev
    - Usa la imagen oficial de Odoo
    - Usa el contenedor db_dev como base de datos (HOST=db_dev)
    - El contenedor no arranca hasta que db_dev no esté arrancado (depends_on)
    - Crea los volúmenes para el filestore y los addons
    - Ejecuta la aplicación en el puerto mapeado 8069
    - Se inicia en modo desarrollador (--dev=all)
- Prod
  - db_prod
    - Usa la base de datos oficial postgres:14
    - Crea un usuario "Odoo" con la contraseña "paso"
    - Guarda los datos en una carpeta diferente (OdooProduccion/dataPG)
    - Ejecuta la base de datos en un puerto diferente para que no colisione con el puerto de Dev
  - odoo_prod
    - Usa la imagen oficial odoo:16.
    - Usa el contenedor db_prod como base de datos (HOST=db_prod).
    - El contenedor no arranca hasta que db_prod no esté arrancado (depends_on).
    - Crea volúmenes separados para el filestore y los addons (usando las carpetas de OdooProduccion).
    - Ejecuta la aplicación en el puerto mapeado 8070 (para no chocar con el 8069 de desarrollo).
    - Se inicia en modo estándar/producción (no se usa --dev=all).